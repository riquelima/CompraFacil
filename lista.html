<!DOCTYPE html>
<html class="light" lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="icon.png" />
    <title>Detalhe da Lista</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&amp;display=swap"
        rel="stylesheet" />
    <link href="css/transitions.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/app.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#6366F1", // Keeping for legacy support
                        "nb-bg": "#E0E7FF",
                        "nb-yellow": "#FFDE00",
                        "nb-pink": "#FF90E8",
                        "nb-green": "#22C55E",
                        "nb-purple": "#8B5CF6",
                        "nb-black": "#111111",
                        "nb-white": "#FFFFFF",
                        "nb-blue": "#3B82F6",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"]
                    },
                    boxShadow: {
                        "neo": "4px 4px 0px 0px #000000",
                        "neo-sm": "2px 2px 0px 0px #000000",
                    },
                    borderWidth: {
                        "3": "3px",
                    }
                },
            },
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .neo-checkbox {
            appearance: none;
            background-color: #fff;
            margin: 0;
            font: inherit;
            width: 1.5rem;
            height: 1.5rem;
            border: 2px solid #000;
            border-radius: 0.375rem;
            display: grid;
            place-content: center;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }

        .neo-checkbox::before {
            content: "";
            width: 0.75rem;
            height: 0.75rem;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em white;
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
            background-color: white;
        }

        .neo-checkbox:checked {
            background-color: #6366F1;
        }

        .neo-checkbox:checked::before {
            transform: scale(1);
            background-color: white;
        }
    </style>
    <style>
        body {
            min-height: max(600px, 100dvh);
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-white overflow-hidden h-screen w-full flex flex-col">
    <div
        class="h-full flex flex-col w-full max-w-full md:max-w-2xl mx-auto bg-background-light dark:bg-background-dark md:border-x-2 md:border-black shadow-none md:shadow-neo-lg relative">
        <header
            class="flex-none px-5 pt-6 pb-4 flex items-center justify-between bg-white dark:bg-card-dark z-20 border-b-2 border-black relative">
            <button onclick="navigate('usuario.html')"
                class="flex size-10 items-center justify-center rounded-lg bg-white dark:bg-card-dark shadow-neo text-slate-900 dark:text-white hover:bg-slate-50 transition-all active:shadow-none active:translate-x-1 active:translate-y-1 border-2 border-black">
                <span class="material-symbols-outlined font-bold">arrow_back</span>
            </button>
            <h1 id="listTitle"
                class="text-xl font-extrabold text-slate-900 dark:text-white tracking-tight flex-1 text-center uppercase">
                Carregando...</h1>
            <button
                class="flex size-10 items-center justify-center rounded-lg bg-white dark:bg-card-dark shadow-neo text-slate-900 dark:text-white hover:bg-slate-50 transition-all active:shadow-none active:translate-x-1 active:translate-y-1 border-2 border-black">
                <span class="material-symbols-outlined font-bold">more_vert</span>
            </button>
        </header>

        <!-- Loading Spinner -->
        <div id="loading" class="flex-1 flex items-center justify-center">
            <div class="size-10 border-4 border-black border-t-transparent rounded-full animate-spin"></div>
        </div>

        <main id="listContent" class="hidden flex-1 overflow-y-auto px-5 pb-52 pt-6 no-scrollbar space-y-4">
            <!-- Dynamic Content Goes Here -->
        </main>

        <div class="absolute bottom-0 left-0 w-full z-30">
            <div class="bg-white dark:bg-background-dark px-5 pb-8 pt-4 border-t-2 border-black">
                <form id="addItemForm" class="relative flex items-center mb-5 gap-3">
                    <div class="relative flex-1">
                        <input id="newItemInput"
                            class="w-full h-14 pl-4 pr-4 rounded-xl bg-white dark:bg-card-dark border-2 border-black text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-0 focus:border-primary text-base font-bold shadow-neo transition-all"
                            placeholder="Adicionar item..." type="text" required autocomplete="off" />
                    </div>
                    <button type="submit"
                        class="size-14 bg-primary hover:bg-primary-dark text-white rounded-xl flex items-center justify-center border-2 border-black shadow-neo active:shadow-none active:translate-x-1 active:translate-y-1 transition-all">
                        <span class="material-symbols-outlined text-3xl">add</span>
                    </button>
                </form>
                <div
                    class="flex items-center justify-between bg-success-light/30 dark:bg-card-dark p-5 rounded-2xl border-2 border-black shadow-neo relative overflow-hidden">
                    <div
                        class="absolute -top-6 -right-6 w-24 h-24 bg-success rounded-full opacity-20 border-2 border-black">
                    </div>
                    <div class="flex flex-col relative z-10">
                        <span class="text-xs font-black text-black dark:text-white uppercase tracking-wider mb-1">Total
                            estimado</span>
                        <div class="flex items-center gap-2">
                            <span id="itemsCount"
                                class="px-2 py-0.5 rounded border border-black bg-white dark:bg-slate-800 text-xs font-bold text-black dark:text-white shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]">0
                                itens</span>
                        </div>
                    </div>
                    <div class="flex items-baseline gap-1 relative z-10">
                        <span class="text-xl font-black text-success-700">R$</span>
                        <span id="totalAmount"
                            class="text-4xl font-black text-success-700 tracking-tighter drop-shadow-sm">0,00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const listId = urlParams.get('id');
        let currentUserId = null;

        const listTitleEl = document.getElementById('listTitle');
        const listContentEl = document.getElementById('listContent');
        const loadingEl = document.getElementById('loading');
        const totalAmountEl = document.getElementById('totalAmount');
        const itemsCountEl = document.getElementById('itemsCount');
        const addItemForm = document.getElementById('addItemForm');
        const newItemInput = document.getElementById('newItemInput');

        async function init() {
            if (!listId) {
                alert('Lista não encontrada');
                navigate('usuario.html');
                return;
            }

            const { data: { session } } = await window.supabaseClient.auth.getSession();
            if (!session) {
                navigate('login.html');
                return;
            }
            currentUserId = session.user.id;

            await fetchListMetadata();
            await fetchListItems();

            loadingEl.classList.add('hidden');
            listContentEl.classList.remove('hidden');
        }

        async function fetchListMetadata() {
            const { data, error } = await window.supabaseClient
                .from('shopping_lists')
                .select('*')
                .eq('id', listId)
                .single();

            if (error) {
                console.error(error);
                listTitleEl.innerText = "Erro ao carregar";
            } else {
                listTitleEl.innerText = data.title;
            }
        }

        async function fetchListItems() {
            const { data: items, error } = await window.supabaseClient
                .from('list_items')
                .select('*')
                .eq('list_id', listId)
                .order('created_at', { ascending: true }); // Newest at bottom usually better for shopping lists? Or alphabetical? Defaulting to creation time.

            if (error) {
                console.error(error);
                return;
            }

            renderItems(items);
            calculateTotals(items);
        }

        function renderItems(items) {
            listContentEl.innerHTML = '';

            const pendingItems = items.filter(i => !i.is_checked);
            const completedItems = items.filter(i => i.is_checked);

            if (pendingItems.length === 0 && completedItems.length === 0) {
                listContentEl.innerHTML = `
                    <div class="flex flex-col items-center justify-center gap-4 mt-20 opacity-50">
                        <span class="material-symbols-outlined text-6xl">shopping_basket</span>
                        <p class="font-bold text-center">Sua lista está vazia.<br>Adicione itens abaixo!</p>
                    </div>
                 `;
                return;
            }

            // Unchecked Items Group
            if (pendingItems.length > 0) {
                const label = document.createElement('div');
                label.className = "flex items-center gap-2 mb-2";
                label.innerHTML = `
                    <div class="h-8 px-3 bg-yellow-300 border-2 border-black rounded-md flex items-center shadow-neo-sm">
                        <span class="text-xs font-bold uppercase tracking-wider text-black">A fazer</span>
                    </div>
                 `;
                listContentEl.appendChild(label);

                pendingItems.forEach(item => {
                    listContentEl.appendChild(createItemElement(item));
                });
            }

            // Checked Items Group
            if (completedItems.length > 0) {
                const label = document.createElement('div');
                label.className = "flex items-center gap-2 mt-6 mb-2";
                label.innerHTML = `
                    <div class="h-8 px-3 bg-green-300 border-2 border-black rounded-md flex items-center shadow-neo-sm">
                        <span class="text-xs font-bold uppercase tracking-wider text-black">Concluídos</span>
                    </div>
                 `;
                listContentEl.appendChild(label);

                completedItems.forEach(item => {
                    listContentEl.appendChild(createItemElement(item));
                });
            }
        }

        let touchStartX = 0;
        let touchCurrentX = 0;

        function createItemElement(item) {
            const isChecked = item.is_checked;

            // Outer Wrapper (Background with Delete Button)
            const wrapper = document.createElement('div');
            wrapper.className = "relative w-full mb-4 rounded-xl overflow-hidden select-none";

            // Background (Delete Action)
            const bg = document.createElement('div');
            bg.className = "absolute inset-y-0 right-0 w-full bg-red-500 flex items-center justify-end px-6 rounded-xl -z-0";
            bg.innerHTML = `<span class="material-symbols-outlined text-white text-3xl font-bold">delete</span>`;

            // Foreground (Content Card)
            const div = document.createElement('div');

            // Apply different styles based on state
            if (isChecked) {
                div.className = "relative z-10 w-full flex items-center gap-4 bg-slate-100 dark:bg-card-dark/40 p-4 rounded-xl border-2 border-slate-400 dark:border-white/10 transition-transform duration-200 ease-out";
            } else {
                div.className = "relative z-10 w-full flex items-center gap-4 bg-white dark:bg-card-dark p-4 rounded-xl shadow-neo border-2 border-black transition-transform duration-200 ease-out";
            }

            // Touch Events
            div.addEventListener('touchstart', (e) => handleTouchStart(e, div, item.id));
            div.addEventListener('touchmove', (e) => handleTouchMove(e, div));
            div.addEventListener('touchend', (e) => handleTouchEnd(e, div, item.id));

            div.innerHTML = `
                <input class="neo-checkbox shrink-0 ${isChecked ? 'grayscale opacity-60' : ''}" type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleItem('${item.id}', ${!isChecked})" />
                <div class="flex-1 min-w-0 flex flex-col">
                    <p class="text-slate-900 dark:text-white text-lg font-bold truncate leading-tight ${isChecked ? 'line-through decoration-2 decoration-slate-400 text-slate-500' : ''}">${item.name}</p>
                </div>
                <div class="shrink-0 px-3 py-1.5 rounded-lg border-2 border-transparent hover:border-black transition-all cursor-pointer ${isChecked ? 'opacity-60' : 'bg-white'}" onclick="event.stopPropagation(); promptPrice('${item.id}', ${item.price})">
                    <p class="text-sm font-bold ${isChecked ? 'text-slate-500 line-through decoration-2' : 'text-primary-dark'}">
                        ${item.price ? `R$ ${formatCurrency(item.price)}` : 'R$ --,--'}
                    </p>
                </div>
            `;

            wrapper.appendChild(bg);
            wrapper.appendChild(div);
            return wrapper;
        }

        function handleTouchStart(e, el, id) {
            touchStartX = e.touches[0].clientX;
            touchCurrentX = touchStartX; // Initialize currentX to startX
            el.style.transition = 'none'; // Disable transition for direct 1:1 movement
        }

        function handleTouchMove(e, el) {
            touchCurrentX = e.touches[0].clientX;
            const diff = touchCurrentX - touchStartX;

            // Only allow swiping left
            if (diff < 0) {
                el.style.transform = `translateX(${diff}px)`;
            }
        }

        function handleTouchEnd(e, el, id) {
            el.style.transition = 'transform 0.3s ease-out';
            const diff = touchCurrentX - touchStartX;
            const threshold = -120; // px to trigger delete

            // Only trigger delete if we actually moved significantly
            if (diff < threshold) {
                // Complete swipe
                el.style.transform = `translateX(-100%)`;
                setTimeout(() => deleteItem(id), 300);
            } else {
                // Reset
                el.style.transform = `translateX(0)`;
            }
        }

        async function deleteItem(id) {
            const { error } = await window.supabaseClient
                .from('list_items')
                .delete()
                .eq('id', id);

            if (!error) {
                fetchListItems();
            } else {
                alert("Erro ao excluir item");
                fetchListItems(); // Reset state on error
            }
        }

        async function toggleItem(itemId, newStatus) {
            // Update item status first
            const { error } = await window.supabaseClient
                .from('list_items')
                .update({ is_checked: newStatus })
                .eq('id', itemId);

            if (!error) {
                // If checking (done) -> Add to inventory
                if (newStatus === true) {
                    await addToInventory(itemId);
                }
                // If unchecking (undo) -> Remove from inventory
                else {
                    await removeFromInventory(itemId);
                }

                fetchListItems(); // Reload UI
            } else {
                alert('Erro ao atualizar item');
            }
        }

        async function addToInventory(itemId) {
            // 1. Get the item details from list_items
            const { data: item, error: fetchError } = await window.supabaseClient
                .from('list_items')
                .select('*')
                .eq('id', itemId)
                .single();

            if (fetchError || !item) return;

            // 2. Check if item exists in inventory (by name and user_id)
            const { data: inventoryItem, error: invError } = await window.supabaseClient
                .from('inventory_items')
                .select('*')
                .eq('user_id', currentUserId)
                .ilike('name', item.name) // Use ilike for case-insensitive match
                .maybeSingle();

            const qtyToAdd = item.quantity || 1; // Default to 1 if not specified

            if (inventoryItem) {
                // 3a. Update existing inventory item
                const newQty = (inventoryItem.quantity || 0) + qtyToAdd;
                await window.supabaseClient
                    .from('inventory_items')
                    .update({ quantity: newQty })
                    .eq('id', inventoryItem.id);

                // Optional: Show a toast/notification? For now, silent.
            } else {
                // 3b. Create new inventory item
                await window.supabaseClient
                    .from('inventory_items')
                    .insert({
                        user_id: currentUserId,
                        name: item.name,
                        category: item.category || 'Outros',
                        quantity: qtyToAdd,
                        unit: 'unid.'
                    });
            }
        }

        async function removeFromInventory(itemId) {
            // 1. Get the item details
            const { data: item, error: fetchError } = await window.supabaseClient
                .from('list_items')
                .select('*')
                .eq('id', itemId)
                .single();

            if (fetchError || !item) return;

            // 2. Check if item exists in inventory
            const { data: inventoryItem, error: invError } = await window.supabaseClient
                .from('inventory_items')
                .select('*')
                .eq('user_id', currentUserId)
                .ilike('name', item.name)
                .maybeSingle();

            if (!inventoryItem) return; // Nothing to remove

            const qtyToRemove = item.quantity || 1;
            const newQty = (inventoryItem.quantity || 0) - qtyToRemove;

            if (newQty <= 0) {
                // Remove entirely
                await window.supabaseClient
                    .from('inventory_items')
                    .delete()
                    .eq('id', inventoryItem.id);
            } else {
                // Decrease quantity
                await window.supabaseClient
                    .from('inventory_items')
                    .update({ quantity: newQty })
                    .eq('id', inventoryItem.id);
            }
        }

        // Just a simple prompt for now. Ideally a modal.
        async function promptPrice(itemId, currentPrice) {
            const newPrice = prompt("Editar preço:", currentPrice || "");
            if (newPrice !== null) {
                const parsed = parseFloat(newPrice.replace(',', '.'));
                if (!isNaN(parsed)) {
                    await window.supabaseClient
                        .from('list_items')
                        .update({ price: parsed })
                        .eq('id', itemId);
                    fetchListItems();
                }
            }
        }

        function calculateTotals(items) {
            let total = 0;
            let count = 0;
            let checkedRaw = 0;

            items.forEach(i => {
                count++;
                if (i.is_checked) checkedRaw++;
                if (i.price) total += Number(i.price);
            });

            itemsCountEl.innerText = `${checkedRaw} de ${count}`;
            totalAmountEl.innerText = formatCurrency(total);

            // Also update the list item_count and total_amount in DB for the dashboard to be fast
            updateListSummary(count, total);
        }

        async function updateListSummary(count, total) {
            await window.supabaseClient
                .from('shopping_lists')
                .update({ item_count: count, total_amount: total })
                .eq('id', listId);
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
        }

        addItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = newItemInput.value.trim();
            if (!name) return;

            newItemInput.disabled = true;

            const { error } = await window.supabaseClient
                .from('list_items')
                .insert({
                    list_id: listId,
                    user_id: currentUserId,
                    name: name,
                    is_checked: false
                });

            newItemInput.disabled = false;
            newItemInput.value = '';
            newItemInput.focus();

            if (!error) {
                fetchListItems();
            } else {
                alert('Erro ao adicionar item');
            }
        });

        init();
    </script>
</body>

</html>