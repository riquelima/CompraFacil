<!DOCTYPE html>
<html class="light" lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>Receitas IA - Neo Brutalism Minimalista</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/app.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "accent-yellow": "#FFDE59",
                        "accent-blue": "#7FBCF5",
                        "accent-green": "#C6E875",
                        "accent-pink": "#FFAFCC",
                        "accent-orange": "#FFAD7A",
                        "background-light": "#F8FAFC",
                        "background-dark": "#101022",
                        "card-dark": "#1E1E2E",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "0.75rem",
                        "xl": "1rem",
                        "2xl": "1.25rem",
                        "full": "9999px"
                    },
                    boxShadow: {
                        "neo": "5px 5px 0px 0px #000000",
                        "neo-hover": "2px 2px 0px 0px #000000",
                        "neo-sm": "3px 3px 0px 0px #000000",
                    },
                    borderWidth: {
                        '3': '3px',
                    }
                },
            },
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        body {
            min-height: max(884px, 100dvh);
        }
    </style>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-white overflow-hidden h-screen w-full flex flex-col selection:bg-black selection:text-white">
    <header
        class="flex-none px-6 pt-8 pb-4 flex items-center justify-between bg-background-light dark:bg-background-dark z-20">
        <button onclick="navigate('inventario.html')"
            class="size-12 flex items-center justify-center border-3 border-black bg-white dark:bg-card-dark rounded-xl shadow-neo active:translate-x-[2px] active:translate-y-[2px] active:shadow-neo-hover transition-all text-black dark:text-white hover:bg-gray-50">
            <span class="material-symbols-outlined text-3xl font-bold">arrow_back</span>
        </button>
        <h1 class="text-2xl font-black uppercase tracking-tighter text-black dark:text-white">Receitas IA</h1>
        <button onclick="resetApiKey()"
            class="size-12 flex items-center justify-center border-3 border-black bg-white dark:bg-card-dark rounded-xl shadow-neo active:translate-x-[2px] active:translate-y-[2px] active:shadow-neo-hover transition-all text-black dark:text-white hover:bg-gray-50">
            <span class="material-symbols-outlined text-3xl font-bold">key</span>
        </button>
    </header>
    <!-- Loading State -->
    <div id="loading" class="hidden flex-col items-center justify-center py-20">
        <div class="size-16 border-4 border-black border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="font-bold text-lg animate-pulse">Consultando a IA...</p>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="hidden flex-col items-center justify-center py-20 px-8 text-center">
        <span class="material-symbols-outlined text-6xl mb-4 opacity-50">kitchen</span>
        <h3 class="text-xl font-black uppercase mb-2">Estoque Vazio</h3>
        <p class="font-bold opacity-60">Adicione itens ao seu estoque para receber sugestões personalizadas.</p>
        <button onclick="navigate('inventario.html')"
            class="mt-6 px-8 py-3 bg-black text-white rounded-xl font-black uppercase tracking-widest shadow-neo hover:scale-105 transition-transform">
            Ir para Estoque
        </button>
    </div>

    <!-- Results Section -->
    <section id="resultsSection" class="flex flex-col gap-8 pb-32">
        <!-- Cards injected via JS -->
    </section>

    </main>

    <!-- Floating FAB to Generate -->
    <div class="fixed bottom-6 right-6 z-30">
        <button onclick="generateRecipes()"
            class="size-20 bg-black text-white rounded-full flex items-center justify-center border-4 border-white dark:border-card-dark shadow-[0px_0px_0px_3px_rgba(0,0,0,1)] active:scale-95 transition-all group hover:bg-gray-900">
            <span
                class="material-symbols-outlined text-4xl group-hover:rotate-180 transition-transform duration-500">auto_awesome</span>
        </button>
    </div>

    <script>
        let inventoryItems = [];
        const DEFAULT_API_KEY = 'AIzaSyDDOAkGR1y9OdVW5LK91TUz3oVYX78g-u8';
        let GEMINI_API_KEY = localStorage.getItem('gemini_api_key') || DEFAULT_API_KEY;

        async function init() {
            console.log("Init started...");
            // Force save default if missing
            if (DEFAULT_API_KEY && !localStorage.getItem('gemini_api_key')) {
                localStorage.setItem('gemini_api_key', DEFAULT_API_KEY);
            }

            const { data: { session } } = await window.supabaseClient.auth.getSession();
            if (!session) {
                console.warn("No session found. Redirecting...");
                navigate('login.html');
                return;
            }

            console.log("Session active. Fetching inventory for:", session.user.id);
            await fetchInventory(session.user.id);
        }

        async function fetchInventory(userId) {
            console.log("Fetching inventory items...");
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('resultsSection').innerHTML = '';

            const { data, error } = await window.supabaseClient
                .from('inventory_items')
                .select('name, quantity, unit')
                .eq('user_id', userId);

            document.getElementById('loading').classList.add('hidden');

            if (error) {
                console.error("Supabase Error:", error);
                alert("Erro ao buscar estoque: " + error.message);
                return;
            }
            console.log("Inventory items fetched:", data);

            if (error || !data || data.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                inventoryItems = [];
            } else {
                inventoryItems = data;
                // Auto generate on first load if we have items
                generateRecipes();
            }
        }

        function resetApiKey() {
            const newKey = prompt("Insira nova chave API (deixe em branco para resetar):", GEMINI_API_KEY);
            if (newKey) {
                localStorage.setItem('gemini_api_key', newKey);
                GEMINI_API_KEY = newKey;
            } else {
                // reverting to default if cleared, or allow full clear?
                // If user wants to clear, maybe they want to change it.
                // let's revert to default if cleared for now as "reset"
                localStorage.setItem('gemini_api_key', DEFAULT_API_KEY);
                GEMINI_API_KEY = DEFAULT_API_KEY;
            }
            alert("Chave API atualizada.");
        }

        async function generateRecipes() {
            if (!inventoryItems || !inventoryItems.length) {
                alert("Seu estoque está vazio! Adicione itens para que a IA possa sugerir receitas.");
                return;
            }

            if (!GEMINI_API_KEY) {
                GEMINI_API_KEY = window.prompt("Por favor, insira sua chave API do Google Gemini:", DEFAULT_API_KEY);
                if (!GEMINI_API_KEY) return;
                localStorage.setItem('gemini_api_key', GEMINI_API_KEY);
            }

            const ingredientsList = inventoryItems.map(i => `${i.quantity}${i.unit} ${i.name}`).join(', ');
            const userPrompt = `
            Você é um chef criativo. Tenho estes ingredientes: ${ingredientsList}.
            Sugira 3 receitas criativas que eu possa fazer PRINCIPALMENTE com estes ingredientes (posso usar itens básicos como sal, óleo, água, temperos).
            Retorne APENAS um JSON válido (sem markdown code blocks) com este formato:
            [
                {
                    "name": "Nome do Prato",
                    "time": "XX min",
                    "difficulty": "Fácil/Médio/Difícil",
                    "type": "Café/Almoço/Jantar/Lanche",
                    "icon": "restaurant_menu", 
                    "ingredients": ["ingrediente 1", "ingrediente 2"],
                    "color": "bg-accent-yellow" (escolha entre bg-accent-yellow, bg-accent-blue, bg-accent-orange, bg-accent-pink aleatoriamente)
                }
            ]
        `;

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('resultsSection').innerHTML = '';
            document.getElementById('emptyState').classList.add('hidden');

            console.log("Calling Gemini API...");
            try {
                // Falling back to gemini-pro if 1.5-flash is unavailable
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userPrompt }] }]
                    })
                });

                console.log("API Response Status:", response.status);
                const data = await response.json();
                console.log("API Data:", data);

                if (data.error) {
                    throw new Error(data.error.message);
                }

                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error("Formato de resposta inesperado da IA. Tente novamente.");
                }

                const text = data.candidates[0].content.parts[0].text;
                // Clean markdown if present
                const cleanJson = text.replace(/```json/g, '').replace(/```/g, '').trim();
                console.log("Cleaned JSON String:", cleanJson);

                let recipes;
                try {
                    recipes = JSON.parse(cleanJson);
                } catch (parseError) {
                    console.error("JSON Parse Error:", parseError, cleanJson);
                    throw new Error("A IA gerou uma resposta inválida. Tente novamente.");
                }

                renderRecipes(recipes);

            } catch (error) {
                console.error(error);
                alert("Erro ao gerar receitas: " + error.message);
                if (error.message.includes("API key")) resetApiKey();
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function renderRecipes(recipes) {
            const container = document.getElementById('resultsSection');
            container.innerHTML = '';

            recipes.forEach(recipe => {
                const html = `
            <article class="group relative ${recipe.color || 'bg-accent-yellow'} border-3 border-black rounded-2xl p-6 shadow-neo active:shadow-neo-hover active:translate-x-[2px] active:translate-y-[2px] transition-all cursor-pointer hover:brightness-95">
                <div class="flex justify-between items-start mb-8">
                    <span class="bg-white border-3 border-black px-4 py-1.5 rounded-lg font-black text-xs uppercase tracking-widest text-black">${recipe.type || 'Geral'}</span>
                    <span class="material-symbols-outlined text-5xl text-black transition-transform group-hover:rotate-12 group-hover:scale-110">${recipe.icon || 'restaurant'}</span>
                </div>
                <h2 class="text-4xl font-black uppercase leading-[0.85] tracking-tight mb-4 text-black break-words">${recipe.name}</h2>
                <div class="mb-6 opacity-80 text-sm font-bold border-l-2 border-black pl-3">
                    ${recipe.ingredients.slice(0, 3).join(', ')}...
                </div>
                <div class="flex items-end justify-between border-t-3 border-black pt-4">
                    <div class="flex flex-col">
                        <span class="text-xs font-bold uppercase mb-0.5 text-black/80">Tempo</span>
                        <span class="text-2xl font-black text-black">${recipe.time}</span>
                    </div>
                    <button class="size-12 bg-black text-white rounded-lg flex items-center justify-center border-2 border-transparent hover:scale-105 transition-transform">
                        <span class="material-symbols-outlined text-2xl">arrow_outward</span>
                    </button>
                </div>
            </article>
            `;
                container.innerHTML += html;
            });
        }

        init();
    </script>

</body>

</html>