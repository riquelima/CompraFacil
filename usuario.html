<!DOCTYPE html>
<html class="light" lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="icon.png" />
    <title>Listas de Compras</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="css/transitions.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/app.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "nb-yellow": "#FFD23F",
                        "nb-purple": "#C596F8",
                        "nb-pink": "#FF85B3",
                        "nb-blue": "#5EBCF7",
                        "nb-green": "#85E0A3",
                        "nb-orange": "#FF9F45",
                        "nb-white": "#FFFFFF",
                        "nb-black": "#000000",
                        "nb-bg": "#F3F0E9",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"]
                    },
                    boxShadow: {
                        "hard": "4px 4px 0px 0px #000000",
                        "hard-sm": "2px 2px 0px 0px #000000",
                        "hard-lg": "6px 6px 0px 0px #000000",
                    },
                    borderRadius: {
                        "nb": "12px",
                    }
                },
            },
        }
    </script>
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            background-color: #F3F0E9;
            background-image: radial-gradient(#000 1px, transparent 1px);
            background-size: 24px 24px;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .card-hover-effect:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px 0px #000000;
        }

        body {
            min-height: max(600px, 100dvh);
        }
    </style>
</head>

<body class="bg-nb-bg font-display text-nb-black h-screen overflow-hidden">
    <div
        class="relative flex h-full w-full flex-col max-w-full md:max-w-2xl mx-auto bg-nb-bg border-x-2 border-nb-black shadow-hard-lg">
        <header
            class="flex-none flex items-center p-6 pb-4 justify-between bg-nb-bg z-10 border-b-2 border-nb-black relative">
            <div class="flex items-center gap-3">
                <div class="relative group cursor-pointer">
                    <div id="userAvatar"
                        class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-12 border-2 border-nb-black shadow-hard-sm bg-gray-200 flex items-center justify-center">
                        <span class="material-symbols-outlined text-gray-400">person</span>
                    </div>
                    <div class="absolute bottom-0 right-0 size-4 bg-nb-green rounded-full border-2 border-nb-black">
                    </div>
                </div>
            </div>
            <div class="flex gap-2">

                <button onclick="navigate('configuracoes.html')"
                    class="flex items-center justify-center size-12 rounded-full bg-nb-white border-2 border-nb-black shadow-hard-sm hover:translate-x-[1px] hover:translate-y-[1px] hover:shadow-none transition-all active:bg-gray-100">
                    <span class="material-symbols-outlined text-[24px] font-bold">settings</span>
                </button>
            </div>
        </header>

        <!-- Loading State -->
        <div id="loadingState" class="flex-1 flex flex-col items-center justify-center p-10 gap-4">
            <div class="size-12 border-4 border-nb-black border-t-transparent rounded-full animate-spin"></div>
            <p class="font-bold text-lg animate-pulse">Carregando...</p>
        </div>

        <!-- content (Initially hidden) -->
        <div id="mainContent" class="hidden flex-col flex-1 overflow-y-auto no-scrollbar">
            <div class="px-6 py-6 bg-nb-white border-b-2 border-nb-black">
                <div class="mb-6">
                    <h2 class="text-nb-black text-sm font-bold uppercase tracking-widest mb-1">Bem-vindo de volta</h2>
                    <h1 class="text-nb-black text-4xl font-extrabold leading-tight tracking-tight uppercase">Ol√°, <span
                            id="userName">Usu√°rio</span>!
                        <span class="inline-block hover:animate-spin">üëã</span>
                    </h1>
                </div>
                <label class="flex flex-col w-full group">
                    <div class="relative flex w-full items-center">
                        <div class="absolute left-4 text-nb-black z-10">
                            <span class="material-symbols-outlined text-[28px]">search</span>
                        </div>
                        <input
                            class="w-full bg-nb-bg border-2 border-nb-black rounded-nb py-4 pl-14 pr-4 text-lg font-bold text-nb-black placeholder:text-gray-500 shadow-hard focus:outline-none focus:ring-0 focus:translate-x-[2px] focus:translate-y-[2px] focus:shadow-none transition-all"
                            placeholder="BUSCAR LISTAS..." value="" />
                    </div>
                </label>
            </div>
            <div class="flex-1 px-6 py-8 pb-32">
                <div class="flex justify-between items-end mb-6">
                    <h3 class="text-2xl font-black text-nb-black uppercase tracking-tight">Minhas Listas</h3>
                    <button
                        class="text-nb-black text-sm font-bold border-b-2 border-nb-black hover:bg-nb-yellow hover:border-transparent transition-colors px-1">VER
                        TODAS</button>
                </div>

                <div id="listsGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                    <!-- Dynamic lists will act here -->

                    <!-- New List Card (Always at the end) -->
                    <div onclick="navigate('novalista.html')"
                        class="group flex flex-col items-center justify-center h-56 rounded-nb border-2 border-dashed border-nb-black bg-white p-4 hover:bg-nb-green transition-all duration-200 cursor-pointer shadow-hard-sm hover:shadow-hard hover:border-solid">
                        <div
                            class="flex items-center justify-center size-16 rounded-full bg-nb-black text-white mb-4 group-hover:scale-110 transition-transform duration-200 border-2 border-transparent group-hover:border-black group-hover:bg-white group-hover:text-black">
                            <span class="material-symbols-outlined text-[32px]">add</span>
                        </div>
                        <h4 class="text-nb-black text-base font-black text-center uppercase">NOVA LISTA</h4>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation Bar -->
        <div class="fixed bottom-0 left-0 w-full z-40 pointer-events-none flex flex-col items-center">
            <div
                class="w-full max-w-2xl bg-white dark:bg-card-dark border-t-2 border-black pointer-events-auto h-20 px-6 flex items-center justify-between shadow-[0_-4px_0_0_rgba(0,0,0,1)] relative">

                <!-- Left: Lists (Active) -->
                <button onclick="navigate('usuario.html', true)"
                    class="flex flex-col items-center gap-1 opacity-100 w-16">
                    <span class="material-symbols-outlined text-3xl font-black text-primary">list_alt</span>
                    <span class="text-[10px] font-bold uppercase tracking-wide">Listas</span>
                </button>

                <!-- Center: FAB (Floating) -->
                <div class="absolute left-1/2 -top-8 -translate-x-1/2">
                    <button onclick="navigate('novalista.html')"
                        class="size-16 bg-nb-yellow rounded-full border-2 border-black shadow-neo flex items-center justify-center hover:scale-110 active:scale-95 transition-all group">
                        <span
                            class="material-symbols-outlined text-4xl text-black font-black group-hover:rotate-90 transition-transform">add</span>
                    </button>
                </div>

                <!-- Right: Inventory (Inactive) -->
                <button onclick="navigate('inventario.html', true)"
                    class="flex flex-col items-center gap-1 opacity-40 hover:opacity-100 transition-opacity w-16">
                    <span
                        class="material-symbols-outlined text-3xl font-bold text-black dark:text-white">inventory_2</span>
                    <span
                        class="text-[10px] font-bold uppercase tracking-wide text-black dark:text-white">Estoque</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingState = document.getElementById('loadingState');
            const mainContent = document.getElementById('mainContent');
            const listsGrid = document.getElementById('listsGrid');
            const userNameEl = document.getElementById('userName');
            const userAvatarEl = document.getElementById('userAvatar');
            const newListCard = listsGrid.lastElementChild; // Keep reference to the 'New List' card

            try {
                // Check Session
                const { data: { session }, error: sessionError } = await window.supabaseClient.auth.getSession();

                if (!session) {
                    navigate('login.html');
                    return;
                }

                // Load User Profile (Name/Avatar)
                const userMeta = session.user.user_metadata;
                if (userMeta && userMeta.full_name) {
                    userNameEl.textContent = userMeta.full_name.split(' ')[0]; // First name
                } else {
                    userNameEl.textContent = session.user.email.split('@')[0];
                }

                if (userMeta && userMeta.avatar_url) {
                    userAvatarEl.style.backgroundImage = `url("${userMeta.avatar_url}")`;
                    userAvatarEl.innerHTML = '';
                }

                // Load Lists
                const { data: lists, error: listsError } = await window.supabaseClient
                    .from('shopping_lists')
                    .select('*')
                    .eq('user_id', session.user.id)
                    .order('created_at', { ascending: false });

                if (listsError) throw listsError;

                // Render Lists
                // Remove everything except the last element (New List Card)
                while (listsGrid.children.length > 1) {
                    listsGrid.removeChild(listsGrid.firstChild);
                }

                // Create HTML string for each list
                // Create HTML string for each list
                lists.forEach(list => {
                    // Outer Wrapper (Relative)
                    const wrapper = document.createElement('div');
                    wrapper.className = "relative w-full h-56 rounded-nb mb-0 select-none overflow-hidden group/wrapper";

                    // Background (Delete Action)
                    const bg = document.createElement('div');
                    bg.className = "absolute inset-0 bg-red-500 flex items-center justify-end px-8 rounded-nb z-0";
                    bg.innerHTML = `<span class="material-symbols-outlined text-white text-4xl font-bold">delete</span>`;

                    // Foreground (Card)
                    const card = document.createElement('div');

                    // Format currency
                    const total = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(list.total_amount || 0);

                    const colorMap = {
                        'nb-yellow': 'bg-nb-yellow',
                        'nb-purple': 'bg-nb-purple',
                        'nb-pink': 'bg-nb-pink',
                        'nb-blue': 'bg-nb-blue',
                        'nb-green': 'bg-nb-green',
                        'nb-orange': 'bg-nb-orange',
                    };
                    const bgClass = colorMap[list.color] || 'bg-white';

                    // Note: We move the onclick to separate logic to prevent click on swipe
                    card.className = `relative z-10 w-full h-full flex flex-col justify-between rounded-nb ${bgClass} border-2 border-nb-black p-4 shadow-hard hover:translate-x-[2px] hover:translate-y-[2px] transition-transform duration-200 cursor-pointer`;

                    // Touch Events
                    let startX = 0;
                    let currentX = 0;
                    let isSwiping = false;

                    card.addEventListener('touchstart', (e) => {
                        startX = e.touches[0].clientX;
                        currentX = startX;
                        card.style.transition = 'none';
                        isSwiping = false;
                    });

                    card.addEventListener('touchmove', (e) => {
                        currentX = e.touches[0].clientX;
                        const diff = currentX - startX;
                        // Only allow left swipe
                        if (diff < 0) {
                            card.style.transform = `translateX(${diff}px)`;
                            isSwiping = true;
                            // Prevent scroll if horizontal swipe is dominant
                            if (Math.abs(diff) > 10) e.preventDefault();
                        }
                    });

                    card.addEventListener('touchend', (e) => {
                        card.style.transition = 'transform 0.3s ease-out';
                        const diff = currentX - startX;
                        if (diff < -120) {
                            // Swipe Threshold Met -> Delete
                            card.style.transform = `translateX(-100%)`;
                            setTimeout(() => deleteList(list.id), 300);
                        } else {
                            // Revert
                            card.style.transform = `translateX(0)`;
                            // If it was a tap (little movement), navigate
                            if (Math.abs(diff) < 10 && !isSwiping) {
                                navigate(`lista.html?id=${list.id}`);
                            }
                        }
                    });

                    // For desktop clicks (fallback)
                    card.onclick = (e) => {
                        // Only trigger if not touchend (hybrid devices) - relying on touch logic mostly for mobile
                        // But simple onclick might fire on tap. 
                        // To avoid double firing with the touch tap detection above, we can check pointer type?
                        // Simplest: only use onclick for desktop, touch devices use touchend logic.
                        // But for simplicity, we let touchend handle navigation on touch.
                        if (e.pointerType === 'mouse') navigate(`lista.html?id=${list.id}`);
                    };


                    card.innerHTML = `
                        <div class="flex justify-between items-start pointer-events-none">
                            <div class="flex items-center justify-center size-12 rounded-lg bg-nb-white border-2 border-nb-black text-nb-black shadow-sm">
                                <span class="material-symbols-outlined text-[28px]">${list.icon || 'shopping_cart'}</span>
                            </div>
                            ${list.item_count > 10 ?
                            `<span class="bg-nb-black text-white text-xs font-bold px-2 py-1 rounded-md border border-nb-black uppercase tracking-wider">Cheia</span>`
                            : ''}
                        </div>
                        <div class="flex flex-col gap-1 mt-3 pointer-events-none">
                            <h4 class="text-nb-black text-lg font-extrabold leading-tight line-clamp-2 uppercase">${list.title}</h4>
                            <p class="text-nb-black font-semibold text-xs opacity-80">${list.item_count || 0} itens</p>
                        </div>
                        <div class="pt-3 border-t-2 border-nb-black mt-auto flex justify-between items-center bg-white/30 -mx-4 -mb-4 p-4 rounded-b-[10px] pointer-events-none">
                            <span class="text-xs font-bold uppercase">Total</span>
                            <p class="text-nb-black text-xl font-black">${total}</p>
                        </div>
                     `;

                    wrapper.appendChild(bg);
                    wrapper.appendChild(card);
                    // Insert before the "New List" card
                    listsGrid.insertBefore(wrapper, newListCard);
                });

            } catch (err) {
                console.error('Error loading dashboard:', err);
                alert('Erro ao carregar dados. Verifique o console.');
            } finally {
                loadingState.classList.add('hidden');
                mainContent.classList.remove('hidden');
                mainContent.classList.add('flex');
            }
        });

        async function deleteList(id) {
            if (!confirm("Tem certeza que deseja excluir esta lista? Ser√° irrevers√≠vel.")) {
                window.location.reload(); // Reset UI
                return;
            }

            try {
                const { error } = await window.supabaseClient
                    .from('shopping_lists')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                // Success - reload to refresh
                window.location.reload();
            } catch (err) {
                console.error("Error deleting list:", err);
                alert("Erro ao excluir lista.");
                window.location.reload();
            }
        }
    </script>
</body>

</html>